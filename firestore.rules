rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Daily token usage collection
    match /daily_token_usage/{documentId} {
      // Allow read/write access to all users since we removed authentication
      allow read, write: if true;
      
      // Validate data structure on write
      allow write: if request.resource.data.keys().hasAll(['date', 'tokensUsed', 'tokenLimit', 'lastUpdated', 'resetAt'])
        && request.resource.data.tokensUsed is int
        && request.resource.data.tokensUsed >= 0
        && request.resource.data.tokenLimit is int
        && request.resource.data.tokenLimit > 0;
    }

    // Token usage history collection for monthly reporting
    match /token_usage_history/{documentId} {
      allow read: if true;
      
      // Only allow system/admin writes for historical data aggregation
      allow write: if false; // Prevent direct client writes
      
      // Allow creation with proper document ID format
      allow create: if request.resource.data.keys().hasAll(['year', 'month', 'dailyUsage', 'totalMonthlyTokens', 'averageDailyUsage', 'peakUsageDate', 'peakUsageTokens', 'createdAt', 'updatedAt'])
        && request.resource.data.year is int
        && request.resource.data.month is int
        && request.resource.data.month >= 1
        && request.resource.data.month <= 12
        && request.resource.data.totalMonthlyTokens is int
        && request.resource.data.totalMonthlyTokens >= 0;
    }

    // Admin access for token usage collections
    match /daily_token_usage/{documentId} {
      // Allow admin users to read all token usage data for reporting
      allow read: if request.auth != null 
        && request.auth.token.admin == true;
    }

    match /token_usage_history/{documentId} {
      // Allow admin users to read and write all historical data
      allow read, write: if request.auth != null 
        && request.auth.token.admin == true;
    }

    // Existing catch-all rule (keep at the end)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}